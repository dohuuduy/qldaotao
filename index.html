<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đào tạo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <button class="navbar-toggler me-2" type="button" id="sidebarToggler" aria-label="Toggle sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <a class="navbar-brand" href="#" data-page="trangTongQuan">
                <i class="fas fa-graduation-cap me-2"></i> Quản lý Đào tạo
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="trangTongQuan">Tổng quan</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="trangKeHoachDaoTao">Kế hoạch</a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#" data-page="trangChonNhanVienDaoTao">Chọn Nhân viên</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> <span id="tenNguoiDung">Người dùng</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="#">Thông tin cá nhân</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="btnDangXuat">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="sidebar" id="appSidebar">
        <nav class="nav flex-column p-3">
            <a class="nav-link" href="#" data-page="trangTheoDoiKetQua"><i class="fas fa-tasks fa-fw"></i> Theo dõi Kết quả</a>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="collapse" href="#collapseDanhMuc" role="button" aria-expanded="false" aria-controls="collapseDanhMuc">
                    <i class="fas fa-cogs fa-fw"></i> Quản lý Danh mục
                </a>
                <div class="collapse" id="collapseDanhMuc">
                    <ul class="nav flex-column ps-3">
                        <li class="nav-item"><a class="nav-link" href="#" data-page="trangDanhMucKhoaHoc"><i class="fas fa-book fa-fw"></i> Khóa đào tạo</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-page="trangDanhMucPhongBan"><i class="fas fa-building fa-fw"></i> Phòng ban</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-page="trangDanhMucGiangVien"><i class="fas fa-chalkboard-teacher fa-fw"></i> Giảng viên</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-page="trangDanhMucDonViDaoTao"><i class="fas fa-school fa-fw"></i> Đơn vị đào tạo</a></li>
                        </ul>
                </div>
            </li>
            <a class="nav-link" href="#" data-page="trangBaoCao"><i class="fas fa-chart-bar fa-fw"></i> Báo cáo</a>
        </nav>
    </div>

    <div class="content-wrapper" id="mainContent">
        <div class="container-fluid">
            <div id="trangTongQuan" class="page-content">
                <h2 class="page-title">Tổng quan</h2>
                <p>Chào mừng bạn đến với Hệ thống Quản lý Đào tạo Nội bộ.</p>
            </div>

            <div id="trangDanhMucKhoaHoc" class="page-content" style="display: none;">
                <h2 class="page-title">Quản lý Danh mục Khóa Đào tạo</h2>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Danh sách Khóa đào tạo</span>
                        <button class="btn btn-primary btn-sm" id="btnMoModalThemKhoaHoc">
                            <i class="fas fa-plus me-1"></i> Thêm Khóa học
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã Khóa</th>
                                        <th>Tên Khóa học</th>
                                        <th>Thời lượng</th>
                                        <th>Hình thức</th>
                                        <th>Chi phí</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="bangDanhSachKhoaHoc"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="trangDanhMucPhongBan" class="page-content" style="display: none;">
                <h2 class="page-title">Quản lý Danh mục Phòng Ban</h2>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Danh sách Phòng Ban</span>
                        <button class="btn btn-primary btn-sm" id="btnMoModalThemPhongBan">
                            <i class="fas fa-plus me-1"></i> Thêm Phòng Ban
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã Phòng Ban</th>
                                        <th>Tên Phòng Ban</th>
                                        <th>Phòng Ban Cha</th>
                                        <th>Email</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="bangDanhSachPhongBan"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="trangDanhMucGiangVien" class="page-content" style="display: none;">
                <h2 class="page-title">Quản lý Danh mục Giảng Viên</h2>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Danh sách Giảng Viên</span>
                        <button class="btn btn-primary btn-sm" id="btnMoModalThemGiangVien">
                            <i class="fas fa-plus me-1"></i> Thêm Giảng Viên
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã GV</th>
                                        <th>Họ Tên</th>
                                        <th>Loại GV</th>
                                        <th>Chuyên môn</th>
                                        <th>Email</th>
                                        <th>Đơn vị</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="bangDanhSachGiangVien"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="trangDanhMucDonViDaoTao" class="page-content" style="display: none;">
                <h2 class="page-title">Quản lý Danh mục Đơn Vị Đào Tạo</h2>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Danh sách Đơn Vị Đào Tạo</span>
                        <button class="btn btn-primary btn-sm" id="btnMoModalThemDonViDaoTao">
                            <i class="fas fa-plus me-1"></i> Thêm Đơn Vị
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã ĐV</th>
                                        <th>Tên Đơn Vị</th>
                                        <th>Email</th>
                                        <th>Website</th>
                                        <th>Lĩnh vực</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="bangDanhSachDonViDaoTao"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="trangKeHoachDaoTao" class="page-content" style="display: none;"><h2 class="page-title">Lập Kế hoạch Đào tạo theo Năm</h2><p class="text-muted">Chức năng đang được phát triển.</p></div>
            <div id="trangYeuCauDaoTao" class="page-content" style="display: none;"><h2 class="page-title">Gửi và Quản lý Yêu cầu Đào tạo</h2><p class="text-muted">Chức năng đang được phát triển.</p></div>
            <div id="trangChonNhanVienDaoTao" class="page-content" style="display: none;"><h2 class="page-title">Chọn Nhân viên tham gia Đào tạo</h2><p class="text-muted">Chức năng đang được phát triển.</p></div>
            <div id="trangTheoDoiKetQua" class="page-content" style="display: none;"><h2 class="page-title">Theo dõi Kết quả Đào tạo</h2><p class="text-muted">Chức năng đang được phát triển.</p></div>
            <div id="trangDanhMucNhanVien" class="page-content" style="display: none;"><h2 class="page-title">Quản lý Danh mục Nhân viên</h2><p class="text-muted">Chức năng đang được phát triển.</p></div>
            <div id="trangDanhMucChucDanh" class="page-content" style="display: none;"><h2 class="page-title">Quản lý Danh mục Chức danh</h2><p class="text-muted">Chức năng đang được phát triển.</p></div>
            <div id="trangDanhMucNguoiPheDuyet" class="page-content" style="display: none;"><h2 class="page-title">Quản lý Danh mục Người phê duyệt</h2><p class="text-muted">Chức năng đang được phát triển.</p></div>
            <div id="trangBaoCao" class="page-content" style="display: none;"><h2 class="page-title">Báo cáo & Thống kê</h2><p class="text-muted">Chức năng đang được phát triển.</p></div>

        </div>
    </div>

    <div class="modal fade" id="modalKhoaHoc" tabindex="-1" aria-labelledby="modalKhoaHocLabel" aria-hidden="true">
         <div class="modal-dialog modal-xl"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalKhoaHocLabel">Thêm Khóa Đào tạo Mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formKhoaHoc">
                        <input type="hidden" id="maKhoaHocAn" value="">
                        <h6><i class="fas fa-info-circle me-2"></i>Thông tin Cơ bản</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tenKhoaHoc" class="form-label">Tên Khóa học <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="tenKhoaHoc" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="maKhoaHoc" class="form-label">Mã Khóa học</label>
                                <input type="text" class="form-control" id="maKhoaHoc" placeholder="Tự động nếu bỏ trống">
                            </div>
                            <div class="col-md-3 mb-3">
                                 <label for="trangThaiKhoaHoc" class="form-label">Trạng thái</label>
                                <select class="form-select" id="trangThaiKhoaHoc">
                                    <option value="Đang hoạt động" selected>Đang hoạt động</option>
                                    <option value="Ngừng hoạt động">Ngừng hoạt động</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="noiDungChinh" class="form-label">Nội dung chính</label>
                            <textarea class="form-control" id="noiDungChinh" rows="3"></textarea>
                        </div>
                        
                        <hr>
                        <h6><i class="fas fa-clock me-2"></i>Thời lượng & <i class="fas fa-dollar-sign me-2"></i>Chi phí</h6>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="thoiLuong" class="form-label">Thời lượng</label>
                                <input type="number" class="form-control" id="thoiLuong" min="0">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="donViThoiLuong" class="form-label">Đơn vị</label>
                                <select class="form-select" id="donViThoiLuong">
                                    <option value="Gio">Giờ</option>
                                    <option value="Ngay">Ngày</option>
                                    <option value="Buoi">Buổi</option>
                                </select>
                            </div>
                             <div class="col-md-3 mb-3">
                                <label for="hinhThucDaoTao" class="form-label">Hình thức</label>
                                <select class="form-select" id="hinhThucDaoTao">
                                    <option value="Online">Online</option>
                                    <option value="Offline">Offline</option>
                                    <option value="Hybrid">Hybrid</option>
                                </select>
                            </div>
                             <div class="col-md-3 mb-3">
                                <label for="chiPhiDuKien" class="form-label">Chi phí Dự kiến</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="chiPhiDuKien" min="0">
                                    <select class="form-select" id="donViTienTe" style="max-width: 100px;">
                                        <option value="VND">VND</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        <h6><i class="fas fa-sitemap me-2"></i>Tổ chức & <i class="fas fa-chalkboard-teacher me-2"></i>Giảng dạy</h6>
                        <div class="row">
                             <div class="col-md-4 mb-3">
                                <label for="maDonViToChucNoiBo" class="form-label">ĐV Tổ chức (Nội bộ)</label>
                                <select class="form-select select2-khoahoc" id="maDonViToChucNoiBo" style="width: 100%;">
                                    <option value="">Chọn phòng ban</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="maDonViDaoTaoNgoai" class="form-label">ĐV Đào tạo (Ngoài)</label>
                                <select class="form-select select2-khoahoc" id="maDonViDaoTaoNgoai" style="width: 100%;">
                                     <option value="">Chọn đơn vị</option>
                                </select>
                            </div>
                             <div class="col-md-4 mb-3">
                                <label for="maGiangVienChinh" class="form-label">Giảng viên chính</label>
                                <select class="form-select select2-khoahoc" id="maGiangVienChinh" style="width: 100%;">
                                    <option value="">Chọn giảng viên</option>
                                </select>
                            </div>
                        </div>
                        
                        <hr>
                        <h6><i class="fas fa-bullseye me-2"></i>Mục tiêu & <i class="fas fa-users me-2"></i>Đối tượng</h6>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="mucTieuKhoaHoc" class="form-label">Mục tiêu khóa học</label>
                                <textarea class="form-control" id="mucTieuKhoaHoc" rows="2"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="doiTuongPhuHop" class="form-label">Đối tượng phù hợp</label>
                                <textarea class="form-control" id="doiTuongPhuHop" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="taiLieuLienQuan" class="form-label">Tài liệu liên quan (Link Google Drive, ...)</label>
                            <input type="text" class="form-control" id="taiLieuLienQuan">
                        </div>
                        <div class="mb-3">
                            <label for="ghiChuKhoaHoc" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="ghiChuKhoaHoc" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="btnLuuKhoaHoc">Lưu Thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalPhongBan" tabindex="-1" aria-labelledby="modalPhongBanLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPhongBanLabel">Thêm Phòng Ban Mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formPhongBan">
                        <input type="hidden" id="maPhongBanAn" value="">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tenPhongBan" class="form-label">Tên Phòng Ban <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="tenPhongBan" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="maPhongBan" class="form-label">Mã Phòng Ban</label>
                                <input type="text" class="form-control" id="maPhongBan" placeholder="Tự động nếu bỏ trống">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="maPhongBanCha" class="form-label">Phòng Ban Cha</label>
                                <select class="form-select select2-phongban" id="maPhongBanCha" style="width: 100%;">
                                    <option value="">Không có</option>
                                    </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="emailPhongBan" class="form-label">Email Phòng Ban</label>
                                <input type="email" class="form-control" id="emailPhongBan">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="soDienThoaiPhongBan" class="form-label">Số Điện Thoại</label>
                                <input type="tel" class="form-control" id="soDienThoaiPhongBan">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="moTaPhongBan" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="moTaPhongBan" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="btnLuuPhongBan">Lưu Thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGiangVien" tabindex="-1" aria-labelledby="modalGiangVienLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalGiangVienLabel">Thêm Giảng Viên Mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formGiangVien">
                        <input type="hidden" id="maGiangVienAn" value="">
                        <h6><i class="fas fa-user-tie me-2"></i>Thông tin Cơ bản</h6>
                        <div class="row">
                            <div class="col-md-5 mb-3">
                                <label for="hoTenGV" class="form-label">Họ Tên Giảng Viên <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="hoTenGV" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="maGiangVienModal" class="form-label">Mã Giảng Viên</label>
                                <input type="text" class="form-control" id="maGiangVienModal" placeholder="Tự động nếu bỏ trống">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="loaiGiangVien" class="form-label">Loại Giảng Viên <span class="text-danger">*</span></label>
                                <select class="form-select" id="loaiGiangVien" onchange="toggleGiangVienFields()">
                                    <option value="Nội bộ" selected>Nội bộ</option>
                                    <option value="Thuê ngoài">Thuê ngoài</option>
                                </select>
                            </div>
                        </div>

                        <div id="khuVucGiangVienNoiBo">
                             <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="maNhanVienGV" class="form-label">Nhân Viên (nếu là GV nội bộ)</label>
                                    <select class="form-select select2-giangvien" id="maNhanVienGV" style="width: 100%;">
                                        <option value="">Chọn nhân viên</option>
                                        </select>
                                </div>
                            </div>
                        </div>

                        <div id="khuVucGiangVienThueNgoai" style="display:none;">
                             <div class="row">
                                 <div class="col-md-6 mb-3">
                                    <label for="maDonViDaoTaoGV" class="form-label">Đơn vị Đào tạo (nếu GV thuê ngoài)</label>
                                    <select class="form-select select2-giangvien" id="maDonViDaoTaoGV" style="width: 100%;">
                                        <option value="">Chọn đơn vị đào tạo</option>
                                        </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="chiPhiThueTheoBuoiGV" class="form-label">Chi phí thuê theo buổi/ngày</label>
                                    <input type="number" class="form-control" id="chiPhiThueTheoBuoiGV" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        <h6><i class="fas fa-address-card me-2"></i>Thông tin Liên hệ & Chuyên môn</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="chuyenMonChinhGV" class="form-label">Chuyên môn chính</label>
                                <input type="text" class="form-control" id="chuyenMonChinhGV">
                            </div>
                             <div class="col-md-6 mb-3">
                                <label for="emailGV" class="form-label">Email</label>
                                <input type="email" class="form-control" id="emailGV">
                            </div>
                        </div>
                        <div class="row">
                           <div class="col-md-6 mb-3">
                                <label for="soDienThoaiGV" class="form-label">Số Điện Thoại</label>
                                <input type="tel" class="form-control" id="soDienThoaiGV">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="danhGiaGV" class="form-label">Đánh giá (1-5 hoặc mô tả)</label>
                                <input type="text" class="form-control" id="danhGiaGV">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="kinhNghiemGV" class="form-label">Kinh nghiệm</label>
                            <textarea class="form-control" id="kinhNghiemGV" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="thongTinKhacGV" class="form-label">Thông tin khác (Link CV, Website,...)</label>
                            <input type="text" class="form-control" id="thongTinKhacGV">
                        </div>
                        <div class="mb-3">
                            <label for="ghiChuGV" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="ghiChuGV" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="btnLuuGiangVien">Lưu Thay đổi</button>
                </div>
            </div>
        </div>
    </div>

     <div class="modal fade" id="modalDonViDaoTao" tabindex="-1" aria-labelledby="modalDonViDaoTaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDonViDaoTaoLabel">Thêm Đơn Vị Đào Tạo Mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formDonViDaoTao">
                        <input type="hidden" id="maDonViDaoTaoAn" value="">
                        <h6><i class="fas fa-school me-2"></i>Thông tin Đơn Vị</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tenDonViDaoTaoModal" class="form-label">Tên Đơn Vị <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="tenDonViDaoTaoModal" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="maDonViDaoTaoModal" class="form-label">Mã Đơn Vị</label>
                                <input type="text" class="form-control" id="maDonViDaoTaoModal" placeholder="Tự động nếu bỏ trống">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="diaChiDVDT" class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="diaChiDVDT">
                        </div>
                        <hr>
                        <h6><i class="fas fa-address-book me-2"></i>Thông tin Liên Hệ</h6>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="emailLienHeDVDT" class="form-label">Email Liên Hệ</label>
                                <input type="email" class="form-control" id="emailLienHeDVDT">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="soDienThoaiLienHeDVDT" class="form-label">Số Điện Thoại</label>
                                <input type="tel" class="form-control" id="soDienThoaiLienHeDVDT">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="websiteDVDT" class="form-label">Website</label>
                                <input type="url" class="form-control" id="websiteDVDT">
                            </div>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nguoiDaiDienDVDT" class="form-label">Người Đại Diện</label>
                                <input type="text" class="form-control" id="nguoiDaiDienDVDT">
                            </div>
                        </div>
                        <hr>
                        <h6><i class="fas fa-info-circle me-2"></i>Thông tin Khác</h6>
                        <div class="row">
                             <div class="col-md-6 mb-3">
                                <label for="linhVucDaoTaoChinhDVDT" class="form-label">Lĩnh vực Đào tạo Chính</label>
                                <input type="text" class="form-control" id="linhVucDaoTaoChinhDVDT">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="danhGiaDonViDVDT" class="form-label">Đánh giá</label>
                                <input type="text" class="form-control" id="danhGiaDonViDVDT">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="ghiChuDVDT" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="ghiChuDVDT" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="btnLuuDonViDaoTao">Lưu Thay đổi</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="modalXacNhanXoa" tabindex="-1" aria-labelledby="modalXacNhanXoaLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="modalXacNhanXoaLabel"><i class="fas fa-exclamation-triangle me-2"></i> Xác nhận Xóa</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Bạn có chắc chắn muốn xóa mục này không?
            <p class="mt-2"><strong>Thông tin:</strong> <span id="thongTinXoaModal"></span></p>
            Hành động này không thể hoàn tác.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-danger" id="btnXacNhanXoaTrongModal">Xóa</button>
          </div>
        </div>
      </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto" id="toastTieuDe">Thông báo</strong>
          <small id="toastThoiGian">Vừa xong</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastNoiDung">
          Nội dung thông báo ở đây.
        </div>
      </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // --- KHAI BAO BIEN TOAN CUC ---
        const API_URL = "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE/exec"; // THAY THE URL NAY
        const CAC_TRANG = document.querySelectorAll('.page-content');
        const modalKhoaHocInstance = new bootstrap.Modal(document.getElementById('modalKhoaHoc'));
        const modalPhongBanInstance = new bootstrap.Modal(document.getElementById('modalPhongBan')); 
        const modalGiangVienInstance = new bootstrap.Modal(document.getElementById('modalGiangVien')); 
        const modalDonViDaoTaoInstance = new bootstrap.Modal(document.getElementById('modalDonViDaoTao')); 
        const modalXacNhanXoaInstance = new bootstrap.Modal(document.getElementById('modalXacNhanXoa')); 
        const toastInstance = new bootstrap.Toast(document.getElementById('liveToast'));
        
        let dangChinhSuaKhoaHoc = false;
        let currentKhoaHocData = null; 
        let dangChinhSuaPhongBan = false; 
        let currentPhongBanData = null; 
        let dangChinhSuaGiangVien = false; 
        let currentGiangVienData = null; 
        let dangChinhSuaDonViDaoTao = false; 
        let currentDonViDaoTaoData = null; 
        let danhSachNhanVienDaChonTamThoi = [];
        let hamXuLyKhiXacNhanXoa = null; 

        // --- KHOI TAO KHI TAI TRANG ---
        document.addEventListener('DOMContentLoaded', function() {
            hienThiTrang('trangTongQuan'); 
            
            if (typeof bootstrap.Collapse === 'undefined') {
                console.error('Bootstrap Collapse component is not loaded or available!');
                hienThiToast('Lỗi nghiêm trọng', 'Thành phần giao diện chính (Collapse) không tải được.', 'error');
            }
            // Khong goi layThongTinNguoiDungHienTai() nua vi se xu ly xac thuc khac khi dung API
            
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            document.getElementById('btnXacNhanXoaTrongModal').addEventListener('click', function() {
                if (typeof hamXuLyKhiXacNhanXoa === 'function') {
                    hamXuLyKhiXacNhanXoa();
                }
                modalXacNhanXoaInstance.hide();
            });

            // Gan su kien click cho cac nut mo modal va luu
            document.getElementById('btnMoModalThemKhoaHoc').addEventListener('click', moModalThemKhoaHoc);
            document.getElementById('btnLuuKhoaHoc').addEventListener('click', luuKhoaHoc);
            document.getElementById('btnMoModalThemPhongBan').addEventListener('click', moModalThemPhongBan);
            document.getElementById('btnLuuPhongBan').addEventListener('click', luuPhongBan);
            document.getElementById('btnMoModalThemGiangVien').addEventListener('click', moModalThemGiangVien);
            document.getElementById('btnLuuGiangVien').addEventListener('click', luuGiangVien);
            document.getElementById('btnMoModalThemDonViDaoTao').addEventListener('click', moModalThemDonViDaoTao);
            document.getElementById('btnLuuDonViDaoTao').addEventListener('click', luuDonViDaoTao);

            // Gan su kien click cho cac link dieu huong
            document.querySelectorAll('.navbar .nav-link[data-page], .sidebar .nav-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    hienThiTrang(this.dataset.page);
                });
            });
            document.getElementById('sidebarToggler').addEventListener('click', toggleSidebar);


            // Khoi tao Select2 cho cac modal khi chung duoc hien thi
             $('#modalKhoaHoc').on('shown.bs.modal', function () {
                const select2Options = { theme: "bootstrap-5", dropdownParent: $(this), width: '100%' };
                if (!$('#maDonViToChucNoiBo').data('select2')) { $('#maDonViToChucNoiBo').select2(select2Options); }
                if (!$('#maDonViDaoTaoNgoai').data('select2')) { $('#maDonViDaoTaoNgoai').select2(select2Options); }
                if (!$('#maGiangVienChinh').data('select2')) { $('#maGiangVienChinh').select2(select2Options); }
                
                if (dangChinhSuaKhoaHoc && currentKhoaHocData) {
                    $('#maDonViToChucNoiBo').val(currentKhoaHocData.maDonViToChucNoiBo || '').trigger('change');
                    $('#maDonViDaoTaoNgoai').val(currentKhoaHocData.maDonViDaoTaoNgoai || '').trigger('change');
                    $('#maGiangVienChinh').val(currentKhoaHocData.maGiangVienChinh || '').trigger('change');
                }
            });
            $('#modalPhongBan').on('shown.bs.modal', function () {
                 if (!$('#maPhongBanCha').data('select2')) {
                    $('#maPhongBanCha').select2({ theme: "bootstrap-5", dropdownParent: $(this), width: '100%' });
                 }
                 if (dangChinhSuaPhongBan && currentPhongBanData) {
                    $('#maPhongBanCha').val(currentPhongBanData.maPhongBanCha || "").trigger('change');
                 }
            });
             $('#modalGiangVien').on('shown.bs.modal', function () {
                const select2OptionsGV = { theme: "bootstrap-5", dropdownParent: $(this), width: '100%' };
                if (!$('#maNhanVienGV').data('select2')) { $('#maNhanVienGV').select2(select2OptionsGV); }
                if (!$('#maDonViDaoTaoGV').data('select2')) { $('#maDonViDaoTaoGV').select2(select2OptionsGV); }

                if (dangChinhSuaGiangVien && currentGiangVienData) {
                    $('#maNhanVienGV').val(currentGiangVienData.maNhanVienGV || "").trigger('change');
                    $('#maDonViDaoTaoGV').val(currentGiangVienData.maDonViDaoTao || "").trigger('change');
                }
            });
        });

        // --- HAM XU LY GIAO DIEN CHUNG (TIEN ICH) ---
        function hienThiTrang(idTrang) {
            CAC_TRANG.forEach(trang => {
                trang.style.display = 'none';
            });
            const trangCanHienThi = document.getElementById(idTrang);
            if (trangCanHienThi) {
                trangCanHienThi.style.display = 'block';
            } else {
                console.error("Khong tim thay trang voi ID: ", idTrang);
                document.getElementById('trangTongQuan').style.display = 'block'; 
            }

            document.querySelectorAll('.navbar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeNavbarLink = document.querySelector(`.navbar .nav-link[data-page="${idTrang}"]`);
            if (activeNavbarLink) {
                activeNavbarLink.classList.add('active');
            }

            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active-sidebar'); 
            });

            const activeSidebarLink = document.querySelector(`.sidebar .nav-link[data-page="${idTrang}"]`);
            if (activeSidebarLink) {
                activeSidebarLink.classList.add('active-sidebar'); 

                const parentCollapseDiv = activeSidebarLink.closest('.collapse'); 
                if (parentCollapseDiv) { 
                    const parentTriggerLink = document.querySelector(`a[data-bs-target="#${parentCollapseDiv.id}"]`);
                    if (parentTriggerLink) {
                        parentTriggerLink.classList.add('active-sidebar'); 
                        var bsCollapse = bootstrap.Collapse.getInstance(parentCollapseDiv);
                        if (!bsCollapse) { 
                            bsCollapse = new bootstrap.Collapse(parentCollapseDiv, {toggle: false});
                        }
                        if (bsCollapse && !parentCollapseDiv.classList.contains('show')) { 
                            bsCollapse.show();
                        } else if (!bsCollapse) {
                             console.error("Khong the khoi tao Bootstrap Collapse cho: ", parentCollapseDiv.id);
                        }
                    }
                }
            }

            // Tai du lieu cho trang cu the khi chuyen trang
            if (idTrang === 'trangDanhMucKhoaHoc') {
                taiDanhSachKhoaHoc();
                taiDuLieuChoSelectsFormKhoaHoc();
            } else if (idTrang === 'trangDanhMucPhongBan') {
                taiDanhSachPhongBan();
                taiDanhSachPhongBanChaChoSelect(); 
            } else if (idTrang === 'trangDanhMucGiangVien') {
                taiDanhSachGiangVien();
                taiDuLieuChoSelectsFormGiangVien();
            } else if (idTrang === 'trangDanhMucDonViDaoTao') {
                taiDanhSachDonViDaoTao();
            }
             else if (idTrang === 'trangChonNhanVienDaoTao') {
                // taiKhoaHocVaoSelectChonNhanVien(); // Se duoc goi khi can
                // taiPhongBanVaoFilterChonNhanVien(); // Se duoc goi khi can
                danhSachNhanVienDaChonTamThoi = []; 
                capNhatDanhSachNhanVienDaChonUI();
                document.getElementById('bangDanhSachNhanVienDeChon').innerHTML = '<tr><td colspan="5" class="text-center">Vui lòng chọn khóa học và áp dụng bộ lọc.</td></tr>';
            }
        }

        function hienThiToast(tieuDe, noiDung, loaiThongBao = 'info') {
            document.getElementById('toastTieuDe').textContent = tieuDe;
            document.getElementById('toastNoiDung').textContent = noiDung;
            const toastHeader = document.querySelector('#liveToast .toast-header');
            toastHeader.classList.remove('bg-success', 'text-white', 'bg-danger', 'text-white', 'bg-warning', 'text-dark', 'bg-info', 'text-white');
            switch (loaiThongBao) {
                case 'success': toastHeader.classList.add('bg-success', 'text-white'); break;
                case 'error': toastHeader.classList.add('bg-danger', 'text-white'); break;
                case 'warning': toastHeader.classList.add('bg-warning', 'text-dark'); break;
                case 'info': default: toastHeader.classList.add('bg-info', 'text-white'); break;
            }
            toastInstance.show();
        }

        function capNhatTenNguoiDung(nguoiDung) {
            // Ham nay se can thay doi neu ban muon lay thong tin nguoi dung tu API
            if (nguoiDung && nguoiDung.email) {
                document.getElementById('tenNguoiDung').textContent = nguoiDung.ten || nguoiDung.email;
            } else {
                document.getElementById('tenNguoiDung').textContent = "Khách";
            }
        }
        
        function xuLyDangXuat() {
            // Ham nay se can thay doi neu ban muon xu ly dang xuat qua API
            hienThiToast('Thông báo', 'Chức năng đăng xuất sẽ được cập nhật.', 'info');
        }

        function toggleSidebar() {
            document.getElementById('appSidebar').classList.toggle('active');
        }
        
        function xuLyLoiAPI(error, context = "") { 
             console.error(`Lỗi API ${context}: `, error);
            const message = error.message || 'Lỗi không xác định từ server.';
            hienThiToast(`Lỗi API ${context}`, 'Có lỗi xảy ra: ' + message, 'error');
        }
        
        // --- MODULE: DANH MUC KHOA HOC ---
        function moModalThemKhoaHoc() {
            dangChinhSuaKhoaHoc = false;
            currentKhoaHocData = null;
            document.getElementById('formKhoaHoc').reset();
            document.getElementById('maKhoaHocAn').value = '';
            document.getElementById('modalKhoaHocLabel').textContent = 'Thêm Khóa Đào tạo Mới';
            document.getElementById('maKhoaHoc').disabled = false;
            taiDuLieuChoSelectsFormKhoaHoc(true); 
            modalKhoaHocInstance.show();
        }

        async function moModalSuaKhoaHoc(maKhoaHoc) {
            console.log("Requesting details for maKhoaHoc:", maKhoaHoc);
            try {
                const response = await fetch(`${API_URL}?action=layChiTietKhoaHoc&maKhoaHoc=${encodeURIComponent(maKhoaHoc)}`);
                const result = await response.json();
                console.log("Response from layChiTietKhoaHoc:", result);

                if (result.success && result.data) {
                    const khoaHoc = result.data;
                    dangChinhSuaKhoaHoc = true;
                    currentKhoaHocData = khoaHoc; 
                    document.getElementById('formKhoaHoc').reset();
                    document.getElementById('modalKhoaHocLabel').textContent = 'Chỉnh sửa Khóa Đào tạo';
                    
                    document.getElementById('maKhoaHocAn').value = khoaHoc.maKhoaHoc; 
                    document.getElementById('maKhoaHoc').value = khoaHoc.maKhoaHoc;
                    document.getElementById('maKhoaHoc').disabled = true;
                    document.getElementById('tenKhoaHoc').value = khoaHoc.tenKhoaHoc;
                    document.getElementById('noiDungChinh').value = khoaHoc.noiDungChinh || '';
                    document.getElementById('thoiLuong').value = khoaHoc.thoiLuong || '';
                    document.getElementById('donViThoiLuong').value = khoaHoc.donViThoiLuong || 'Gio'; 
                    document.getElementById('chiPhiDuKien').value = khoaHoc.chiPhiDuKien || '';
                    document.getElementById('donViTienTe').value = khoaHoc.donViTienTe || 'VND';
                    document.getElementById('hinhThucDaoTao').value = khoaHoc.hinhThucDaoTao || 'Offline';
                    document.getElementById('trangThaiKhoaHoc').value = khoaHoc.trangThaiKhoaHoc || 'Đang hoạt động';
                    
                    taiDuLieuChoSelectsFormKhoaHoc(true); 
                    
                    document.getElementById('taiLieuLienQuan').value = khoaHoc.taiLieuLienQuan || '';
                    document.getElementById('mucTieuKhoaHoc').value = khoaHoc.mucTieuKhoaHoc || '';
                    document.getElementById('doiTuongPhuHop').value = khoaHoc.doiTuongPhuHop || '';
                    document.getElementById('ghiChuKhoaHoc').value = khoaHoc.ghiChu || '';
                    modalKhoaHocInstance.show();
                } else {
                    hienThiToast('Lỗi', result.message || 'Không tìm thấy thông tin khóa học.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "moModalSuaKhoaHoc");
            }
        }

        async function luuKhoaHoc() {
            const khoaHocData = {
                maKhoaHoc: document.getElementById('maKhoaHoc').value.trim(),
                tenKhoaHoc: document.getElementById('tenKhoaHoc').value.trim(),
                noiDungChinh: document.getElementById('noiDungChinh').value.trim(),
                thoiLuong: document.getElementById('thoiLuong').value,
                donViThoiLuong: document.getElementById('donViThoiLuong').value, 
                chiPhiDuKien: document.getElementById('chiPhiDuKien').value,
                donViTienTe: document.getElementById('donViTienTe').value,
                hinhThucDaoTao: document.getElementById('hinhThucDaoTao').value,
                maDonViToChucNoiBo: $('#maDonViToChucNoiBo').val(), 
                maDonViDaoTaoNgoai: $('#maDonViDaoTaoNgoai').val(),
                maGiangVienChinh: $('#maGiangVienChinh').val(), 
                taiLieuLienQuan: document.getElementById('taiLieuLienQuan').value.trim(),
                mucTieuKhoaHoc: document.getElementById('mucTieuKhoaHoc').value.trim(),
                doiTuongPhuHop: document.getElementById('doiTuongPhuHop').value.trim(),
                trangThaiKhoaHoc: document.getElementById('trangThaiKhoaHoc').value,
                ghiChu: document.getElementById('ghiChuKhoaHoc').value.trim()
            };

            if (!khoaHocData.tenKhoaHoc) {
                hienThiToast('Lỗi', 'Tên khóa học không được để trống.', 'error');
                return;
            }

            let payload;
            if (dangChinhSuaKhoaHoc) {
                khoaHocData.maKhoaHoc = document.getElementById('maKhoaHocAn').value; 
                payload = { action: 'capNhatKhoaHoc', duLieu: khoaHocData };
            } else {
                payload = { action: 'themKhoaHoc', duLieu: khoaHocData };
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.success || result.thanhCong) { 
                    hienThiToast('Thành công', result.message || result.thongBao || (dangChinhSuaKhoaHoc ? "Cập nhật thành công!" : "Thêm mới thành công!"), 'success');
                    modalKhoaHocInstance.hide();
                    taiDanhSachKhoaHoc();
                } else {
                    hienThiToast('Lỗi', result.message || result.thongBao || 'Có lỗi xảy ra từ server.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "luuKhoaHoc");
            }
        }
        
        async function taiDanhSachKhoaHoc() {
            const tbody = document.getElementById('bangDanhSachKhoaHoc');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Đang tải...</td></tr>';
            try {
                const response = await fetch(`${API_URL}?action=layDanhSachKhoaHoc`);
                const result = await response.json();

                if (result.success && result.data) {
                    hienThiDanhSachKhoaHoc(result.data);
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center">${result.message || 'Không tải được dữ liệu.'}</td></tr>`;
                    hienThiToast('Lỗi', result.message || 'Không tải được danh sách khóa học.', 'error');
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Lỗi khi tải dữ liệu.</td></tr>';
                xuLyLoiAPI(error, "taiDanhSachKhoaHoc");
            }
        }

        function hienThiDanhSachKhoaHoc(danhSachMang) {
            const tbody = document.getElementById('bangDanhSachKhoaHoc');
            tbody.innerHTML = '';
            if (!danhSachMang || danhSachMang.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Không có dữ liệu khóa học.</td></tr>';
                return;
            }
            danhSachMang.forEach(khoaHoc => {
                const tr = document.createElement('tr');
                let donViThoiLuongDisplay = khoaHoc.donViThoiLuong || '';
                if (donViThoiLuongDisplay.toLowerCase() === 'gio') donViThoiLuongDisplay = 'Giờ';
                else if (donViThoiLuongDisplay.toLowerCase() === 'ngay') donViThoiLuongDisplay = 'Ngày';
                else if (donViThoiLuongDisplay.toLowerCase() === 'buoi') donViThoiLuongDisplay = 'Buổi';

                let tooltipContent = '';
                if (khoaHoc.tenGiangVienChinh) {
                    tooltipContent += `<b>Giảng viên:</b> ${khoaHoc.tenGiangVienChinh}<br>`;
                }
                let donViToChucDisplay = '';
                if (khoaHoc.tenDonViToChucNoiBo) {
                    donViToChucDisplay = khoaHoc.tenDonViToChucNoiBo + " (Nội bộ)";
                } else if (khoaHoc.tenDonViDaoTaoNgoai) {
                    donViToChucDisplay = khoaHoc.tenDonViDaoTaoNgoai + " (Ngoài)";
                }
                if (donViToChucDisplay) {
                     tooltipContent += `<b>Đơn vị tổ chức:</b> ${donViToChucDisplay}<br>`;
                }
                if (khoaHoc.hinhThucDaoTao) {
                     tooltipContent += `<b>Hình thức:</b> ${khoaHoc.hinhThucDaoTao}`;
                }
                
                tr.innerHTML = `
                    <td><span class="ma-khoa-hoc-rut-gon" data-bs-toggle="tooltip" title="${khoaHoc.maKhoaHoc || ''}">${khoaHoc.maKhoaHoc || ''}</span></td>
                    <td><span class="ten-khoa-hoc-tooltip" data-bs-toggle="tooltip" data-bs-html="true" title="${tooltipContent.replace(/"/g, '&quot;')}">${khoaHoc.tenKhoaHoc || ''}</span></td>
                    <td>${khoaHoc.thoiLuong || ''} ${donViThoiLuongDisplay}</td>
                    <td>${khoaHoc.hinhThucDaoTao || ''}</td>
                    <td>${khoaHoc.chiPhiDuKien ? new Intl.NumberFormat('vi-VN').format(khoaHoc.chiPhiDuKien) + ' ' + (khoaHoc.donViTienTe || 'VND') : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick='moModalSuaKhoaHoc("${khoaHoc.maKhoaHoc}")' title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick='xacNhanXoaKhoaHocAPI("${khoaHoc.maKhoaHoc}", "${khoaHoc.tenKhoaHoc}")' title="Xóa"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            var tooltipTriggerList = [].slice.call(tbody.querySelectorAll('[data-bs-toggle="tooltip"]'))
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
        }
        
        function xacNhanXoaKhoaHocAPI(maKhoaHoc, tenKhoaHoc) {
            document.getElementById('thongTinXoaModal').textContent = `Khóa học: ${tenKhoaHoc} (Mã: ${maKhoaHoc})`;
            hamXuLyKhiXacNhanXoa = function() {
                thucHienXoaKhoaHocAPI(maKhoaHoc, tenKhoaHoc);
            };
            modalXacNhanXoaInstance.show();
        }

        async function thucHienXoaKhoaHocAPI(maKhoaHoc, tenKhoaHoc) {
            const payload = { action: 'xoaKhoaHoc', maKhoaHoc: maKhoaHoc };
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success || result.thanhCong) {
                    hienThiToast('Thành công', result.message || result.thongBao || `Đã xóa khóa học "${tenKhoaHoc}".`, 'success');
                    taiDanhSachKhoaHoc();
                } else {
                    hienThiToast('Lỗi', result.message || result.thongBao || 'Xóa khóa học thất bại.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "thucHienXoaKhoaHocAPI");
            }
        }

        async function taiDuLieuChoSelectsFormKhoaHoc(resetOptions = false, callback) {
            let loadedCount = 0;
            const totalSelects = 3;
            const select2Options = { theme: "bootstrap-5", dropdownParent: $('#modalKhoaHoc'), width: '100%' };

            const initOrUpdateSelect2 = (selectId, options) => {
                const $select = $(`#${selectId}`);
                if ($select.data('select2')) { $select.select2('destroy').empty(); } // Huy va xoa option cu
                $select.select2(options); 
            };
            
            const populateSelect = async (selectId, placeholder, actionName, valueField, textField, additionalTextFn) => {
                try {
                    const response = await fetch(`${API_URL}?action=${actionName}`);
                    const result = await response.json();
                    const select = $(`#${selectId}`);
                    const currentValue = select.val();
                    select.empty().append(new Option(placeholder, ''));
                    if (result.success && result.data) {
                        result.data.forEach(item => {
                            let text = item[textField];
                            if (additionalTextFn) text += additionalTextFn(item);
                            select.append(new Option(text, item[valueField]));
                        });
                    }
                    if (resetOptions || !select.find(`option[value="${currentValue}"]`).length) {
                        select.val("").trigger('change');
                    } else {
                        select.val(currentValue).trigger('change');
                    }
                } catch (error) {
                    xuLyLoiAPI(error, `taiDuLieuChoSelects (${selectId})`);
                } finally {
                    loadedCount++;
                    if (loadedCount === totalSelects) {
                        initOrUpdateSelect2('maDonViToChucNoiBo', select2Options);
                        initOrUpdateSelect2('maDonViDaoTaoNgoai', select2Options);
                        initOrUpdateSelect2('maGiangVienChinh', select2Options);
                        if (callback) callback();
                    }
                }
            };

            populateSelect('maDonViToChucNoiBo', 'Chọn phòng ban', 'layDanhSachPhongBan', 'maPhongBan', 'tenPhongBan');
            populateSelect('maDonViDaoTaoNgoai', 'Chọn đơn vị đào tạo', 'layDanhSachDonViDaoTao', 'maDonViDaoTao', 'tenDonViDaoTao');
            populateSelect('maGiangVienChinh', 'Chọn giảng viên', 'layDanhSachGiangVien', 'maGiangVien', 'hoTenGV', item => ` (${item.loaiGiangVien || 'N/A'})`);
        }

        // --- MODULE: DANH MUC PHONG BAN ---
        function moModalThemPhongBan() {
            dangChinhSuaPhongBan = false;
            currentPhongBanData = null;
            document.getElementById('formPhongBan').reset();
            document.getElementById('maPhongBanAn').value = '';
            document.getElementById('modalPhongBanLabel').textContent = 'Thêm Phòng Ban Mới';
            document.getElementById('maPhongBan').disabled = false;
            taiDanhSachPhongBanChaChoSelect(true); 
            modalPhongBanInstance.show();
        }

        function moModalSuaPhongBan(phongBanDuLieu) {
            dangChinhSuaPhongBan = true;
            currentPhongBanData = phongBanDuLieu;
            document.getElementById('formPhongBan').reset();
            document.getElementById('modalPhongBanLabel').textContent = 'Chỉnh sửa Phòng Ban';

            document.getElementById('maPhongBanAn').value = phongBanDuLieu.maPhongBan;
            document.getElementById('maPhongBan').value = phongBanDuLieu.maPhongBan;
            document.getElementById('maPhongBan').disabled = true;
            document.getElementById('tenPhongBan').value = phongBanDuLieu.tenPhongBan;
            document.getElementById('emailPhongBan').value = phongBanDuLieu.emailPhongBan || "";
            document.getElementById('soDienThoaiPhongBan').value = phongBanDuLieu.soDienThoaiPhongBan || "";
            document.getElementById('moTaPhongBan').value = phongBanDuLieu.moTa || "";
            
            taiDanhSachPhongBanChaChoSelect(true); 
            modalPhongBanInstance.show();
        }

        async function luuPhongBan() {
            const phongBanData = {
                maPhongBan: document.getElementById('maPhongBan').value.trim(),
                tenPhongBan: document.getElementById('tenPhongBan').value.trim(),
                maPhongBanCha: $('#maPhongBanCha').val(),
                emailPhongBan: document.getElementById('emailPhongBan').value.trim(),
                soDienThoaiPhongBan: document.getElementById('soDienThoaiPhongBan').value.trim(),
                moTa: document.getElementById('moTaPhongBan').value.trim()
            };

            if (!phongBanData.tenPhongBan) {
                hienThiToast('Lỗi', 'Tên phòng ban không được để trống.', 'error'); return;
            }

            let payload;
            if (dangChinhSuaPhongBan) {
                phongBanData.maPhongBan = document.getElementById('maPhongBanAn').value; 
                payload = { action: 'capNhatPhongBan', duLieu: phongBanData };
            } else {
                payload = { action: 'themPhongBan', duLieu: phongBanData };
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success || result.thanhCong) {
                    hienThiToast('Thành công', result.message || result.thongBao || (dangChinhSuaPhongBan ? "Cập nhật thành công!" : "Thêm mới thành công!"), 'success');
                    modalPhongBanInstance.hide();
                    taiDanhSachPhongBan(); 
                    taiDanhSachPhongBanChaChoSelect(true); 
                } else {
                    hienThiToast('Lỗi', result.message || result.thongBao || 'Có lỗi xảy ra.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "luuPhongBan");
            }
        }

        async function taiDanhSachPhongBan() {
            const tbody = document.getElementById('bangDanhSachPhongBan');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div> Đang tải...</td></tr>';
            try {
                const response = await fetch(`${API_URL}?action=layDanhSachPhongBanDayDu`);
                const result = await response.json();
                if (result.success && result.data) {
                    hienThiDanhSachPhongBan(result.data);
                } else {
                     tbody.innerHTML = `<tr><td colspan="5" class="text-center">${result.message || 'Không tải được dữ liệu.'}</td></tr>`;
                    hienThiToast('Lỗi', result.message || 'Không tải được danh sách phòng ban.', 'error');
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Lỗi khi tải dữ liệu.</td></tr>';
                xuLyLoiAPI(error, "taiDanhSachPhongBan");
            }
        }

        function hienThiDanhSachPhongBan(danhSachPhongBan) {
            const tbody = document.getElementById('bangDanhSachPhongBan');
            tbody.innerHTML = '';
            if (!danhSachPhongBan || danhSachPhongBan.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Không có dữ liệu phòng ban.</td></tr>';
                return;
            }
            const phongBanMap = danhSachPhongBan.reduce((map, pb) => { map[pb.maPhongBan] = pb.tenPhongBan; return map; }, {});

            danhSachPhongBan.forEach(pb => {
                const tr = document.createElement('tr');
                const tenPhongBanCha = pb.maPhongBanCha ? (phongBanMap[pb.maPhongBanCha] || pb.maPhongBanCha) : 'Không có';
                tr.innerHTML = `
                    <td>${pb.maPhongBan || ''}</td>
                    <td>${pb.tenPhongBan || ''}</td>
                    <td>${tenPhongBanCha}</td>
                    <td>${pb.emailPhongBan || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick='suaPhongBanAPI("${pb.maPhongBan}")' title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick='xacNhanXoaPhongBanAPI("${pb.maPhongBan}", "${pb.tenPhongBan}")' title="Xóa"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        async function suaPhongBanAPI(maPhongBan) {
             try {
                const response = await fetch(`${API_URL}?action=layChiTietPhongBan&maPhongBan=${encodeURIComponent(maPhongBan)}`);
                const result = await response.json();
                if (result.success && result.data) {
                    moModalSuaPhongBan(result.data);
                } else {
                    hienThiToast('Lỗi', result.message || 'Không tìm thấy thông tin phòng ban.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "suaPhongBanAPI");
            }
        }

        function xacNhanXoaPhongBanAPI(maPhongBan, tenPhongBan) {
            document.getElementById('thongTinXoaModal').textContent = `Phòng ban: ${tenPhongBan} (Mã: ${maPhongBan})`;
            hamXuLyKhiXacNhanXoa = function() {
                thucHienXoaPhongBanAPI(maPhongBan, tenPhongBan);
            };
            modalXacNhanXoaInstance.show();
        }

        async function thucHienXoaPhongBanAPI(maPhongBan, tenPhongBan) {
            const payload = { action: 'xoaPhongBan', maPhongBan: maPhongBan };
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.success || result.thanhCong) {
                    hienThiToast('Thành công', result.message || result.thongBao || `Đã xóa phòng ban "${tenPhongBan}".`, 'success');
                    taiDanhSachPhongBan();
                    taiDanhSachPhongBanChaChoSelect(true); 
                } else {
                    hienThiToast('Lỗi', result.message || result.thongBao || 'Xóa phòng ban thất bại.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "thucHienXoaPhongBanAPI");
            }
        }

        async function taiDanhSachPhongBanChaChoSelect(resetOptions = false, callback) {
            try {
                const response = await fetch(`${API_URL}?action=layDanhSachPhongBan`);
                const result = await response.json();
                const select = $('#maPhongBanCha'); 
                const currentValue = select.val(); 
                select.empty().append(new Option('Không có', '')); 
                if (result.success && result.data) {
                    result.data.forEach(item => {
                        select.append(new Option(item.tenPhongBan, item.maPhongBan));
                    });
                }
                
                if (select.data('select2')) { 
                    select.trigger('change.select2'); 
                } else {
                    select.select2({ theme: "bootstrap-5", dropdownParent: $('#modalPhongBan'), width: '100%' });
                }
                
                if (currentValue && select.find(`option[value="${currentValue}"]`).length && !resetOptions) {
                     select.val(currentValue).trigger('change');
                } else {
                     select.val("").trigger('change');
                }

                if(callback) callback();
            } catch (error) {
                xuLyLoiAPI(error, "taiDanhSachPhongBanChaChoSelect");
                if(callback) callback();
            }
        }

        // --- MODULE: DANH MUC GIANG VIEN ---
        // (Cac ham cho Giang Vien se duoc cap nhat tuong tu de su dung fetch API)
        function moModalThemGiangVien() {
            dangChinhSuaGiangVien = false;
            currentGiangVienData = null;
            document.getElementById('formGiangVien').reset();
            document.getElementById('maGiangVienAn').value = '';
            document.getElementById('modalGiangVienLabel').textContent = 'Thêm Giảng Viên Mới';
            document.getElementById('maGiangVienModal').disabled = false;
            document.getElementById('loaiGiangVien').value = 'Nội bộ'; 
            toggleGiangVienFields(); 
            taiDuLieuChoSelectsFormGiangVien(true);
            modalGiangVienInstance.show();
        }

        async function moModalSuaGiangVien(giangVienDuLieu) {
            dangChinhSuaGiangVien = true;
            currentGiangVienData = giangVienDuLieu;
            document.getElementById('formGiangVien').reset();
            document.getElementById('modalGiangVienLabel').textContent = 'Chỉnh sửa Giảng Viên';

            document.getElementById('maGiangVienAn').value = giangVienDuLieu.maGiangVien;
            document.getElementById('maGiangVienModal').value = giangVienDuLieu.maGiangVien;
            document.getElementById('maGiangVienModal').disabled = true;
            document.getElementById('hoTenGV').value = giangVienDuLieu.hoTenGV;
            document.getElementById('loaiGiangVien').value = giangVienDuLieu.loaiGiangVien;
            toggleGiangVienFields(); 

            await taiDuLieuChoSelectsFormGiangVien(true); // Doi tai xong
            $('#maNhanVienGV').val(giangVienDuLieu.maNhanVienGV || "").trigger('change');
            $('#maDonViDaoTaoGV').val(giangVienDuLieu.maDonViDaoTao || "").trigger('change'); 
            
            document.getElementById('chiPhiThueTheoBuoiGV').value = giangVienDuLieu.chiPhiThueTheoBuoi || "";
            document.getElementById('chuyenMonChinhGV').value = giangVienDuLieu.chuyenMonChinh || "";
            document.getElementById('emailGV').value = giangVienDuLieu.emailGV || "";
            document.getElementById('soDienThoaiGV').value = giangVienDuLieu.soDienThoaiGV || "";
            document.getElementById('danhGiaGV').value = giangVienDuLieu.danhGiaGV || "";
            document.getElementById('kinhNghiemGV').value = giangVienDuLieu.kinhNghiem || "";
            document.getElementById('thongTinKhacGV').value = giangVienDuLieu.thongTinKhac || "";
            document.getElementById('ghiChuGV').value = giangVienDuLieu.ghiChu || "";
            
            modalGiangVienInstance.show();
        }
        
        function toggleGiangVienFields() {
            const loaiGV = document.getElementById('loaiGiangVien').value;
            const khuVucNoiBo = document.getElementById('khuVucGiangVienNoiBo');
            const khuVucThueNgoai = document.getElementById('khuVucGiangVienThueNgoai');

            if (loaiGV === 'Nội bộ') {
                khuVucNoiBo.style.display = 'block'; 
                khuVucThueNgoai.style.display = 'none';
            } else { 
                khuVucNoiBo.style.display = 'none';
                khuVucThueNgoai.style.display = 'block'; 
            }
        }

        async function taiDuLieuChoSelectsFormGiangVien(resetOptions = false, callback){
            let loadedCountGV = 0;
            const totalSelectsGV = 2;
            const select2OptionsGV = { theme: "bootstrap-5", dropdownParent: $('#modalGiangVien'), width: '100%' };

            const checkAllLoadedGV = () => {
                loadedCountGV++;
                if(loadedCountGV === totalSelectsGV) {
                    if ($('#maNhanVienGV').data('select2')) { $('#maNhanVienGV').trigger('change'); } 
                    else { $('#maNhanVienGV').select2(select2OptionsGV); }

                    if ($('#maDonViDaoTaoGV').data('select2')) { $('#maDonViDaoTaoGV').trigger('change'); }
                    else { $('#maDonViDaoTaoGV').select2(select2OptionsGV); }
                    
                    if (callback) callback();
                }
            }
            const populateSelectGV = async (selectId, placeholder, actionName, valueField, textField, additionalTextFn) => {
                try {
                    const response = await fetch(`${API_URL}?action=${actionName}`);
                    const result = await response.json();
                    const select = $(`#${selectId}`);
                    const currentValue = select.val();
                    select.empty().append(new Option(placeholder, ''));
                    if (result.success && result.data) {
                        result.data.forEach(item => { 
                            let text = item[textField];
                            if(additionalTextFn) text = additionalTextFn(item);
                            select.append(new Option(text, item[valueField]));
                        });
                    }
                    if (resetOptions || !select.find(`option[value="${currentValue}"]`).length) {
                        select.val("").trigger('change');
                    } else {
                        select.val(currentValue).trigger('change');
                    }
                } catch (error) {
                    xuLyLoiAPI(error, `taiDuLieuSelectsGV (${selectId})`);
                } finally {
                    checkAllLoadedGV();
                }
            };
            
            populateSelectGV('maNhanVienGV', 'Chọn nhân viên', 'layDanhSachNhanVien', 'maNhanVien', 'hoTen', item => ` (${item.maNhanVien || 'N/A'})`);
            populateSelectGV('maDonViDaoTaoGV', 'Chọn đơn vị đào tạo', 'layDanhSachDonViDaoTao', 'maDonViDaoTao', 'tenDonViDaoTao');
        }


        async function luuGiangVien() {
            const giangVienData = {
                maGiangVien: document.getElementById('maGiangVienModal').value.trim(),
                hoTenGV: document.getElementById('hoTenGV').value.trim(),
                loaiGiangVien: document.getElementById('loaiGiangVien').value,
                maNhanVienGV: $('#maNhanVienGV').val(), 
                maDonViDaoTao: $('#maDonViDaoTaoGV').val(), 
                chiPhiThueTheoBuoi: document.getElementById('chiPhiThueTheoBuoiGV').value,
                chuyenMonChinh: document.getElementById('chuyenMonChinhGV').value.trim(),
                emailGV: document.getElementById('emailGV').value.trim(),
                soDienThoaiGV: document.getElementById('soDienThoaiGV').value.trim(),
                danhGiaGV: document.getElementById('danhGiaGV').value.trim(),
                kinhNghiem: document.getElementById('kinhNghiemGV').value.trim(),
                thongTinKhac: document.getElementById('thongTinKhacGV').value.trim(),
                ghiChu: document.getElementById('ghiChuGV').value.trim()
            };

            if (!giangVienData.hoTenGV) {
                hienThiToast('Lỗi', 'Họ tên giảng viên không được để trống.', 'error'); return;
            }
            if (!giangVienData.loaiGiangVien) {
                hienThiToast('Lỗi', 'Vui lòng chọn loại giảng viên.', 'error'); return;
            }
            
            if (giangVienData.loaiGiangVien === 'Thuê ngoài') {
                giangVienData.maNhanVienGV = ""; 
            } else {
                giangVienData.maDonViDaoTao = ""; 
                giangVienData.chiPhiThueTheoBuoi = "";
            }

            let payload;
            if (dangChinhSuaGiangVien) {
                giangVienData.maGiangVien = document.getElementById('maGiangVienAn').value; 
                payload = { action: 'capNhatGiangVien', duLieu: giangVienData };
            } else {
                payload = { action: 'themGiangVien', duLieu: giangVienData };
            }
             try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.success || result.thanhCong) {
                    hienThiToast('Thành công', result.message || result.thongBao || (dangChinhSuaGiangVien ? "Cập nhật thành công!" : "Thêm mới thành công!"), 'success');
                    modalGiangVienInstance.hide();
                    taiDanhSachGiangVien(); 
                } else {
                    hienThiToast('Lỗi', result.message || result.thongBao || 'Có lỗi xảy ra.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "luuGiangVien");
            }
        }

        async function taiDanhSachGiangVien() {
            const tbody = document.getElementById('bangDanhSachGiangVien');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> Đang tải...</td></tr>';
            try {
                const response = await fetch(`${API_URL}?action=layDanhSachGiangVienDayDu`);
                const result = await response.json();
                if (result.success && result.data) {
                    hienThiDanhSachGiangVien(result.data);
                } else {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center">${result.message || 'Không tải được dữ liệu.'}</td></tr>`;
                    hienThiToast('Lỗi', result.message || 'Không tải được danh sách giảng viên.', 'error');
                }
            } catch (error) {
                 tbody.innerHTML = '<tr><td colspan="7" class="text-center">Lỗi khi tải dữ liệu.</td></tr>';
                xuLyLoiAPI(error, "taiDanhSachGiangVien");
            }
        }

        function hienThiDanhSachGiangVien(danhSachGV) {
            const tbody = document.getElementById('bangDanhSachGiangVien');
            tbody.innerHTML = '';
            if (!danhSachGV || danhSachGV.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Không có dữ liệu giảng viên.</td></tr>';
                return;
            }
            danhSachGV.forEach(gv => {
                const tr = document.createElement('tr');
                let donViDisplay = '';
                if (gv.loaiGiangVien === 'Nội bộ' && gv.tenNhanVienGV) { 
                    donViDisplay = `NV: ${gv.tenNhanVienGV}`;
                } else if (gv.loaiGiangVien === 'Thuê ngoài' && gv.tenDonViDaoTaoGV) { 
                    donViDisplay = `ĐV: ${gv.tenDonViDaoTaoGV}`;
                }

                tr.innerHTML = `
                    <td>${gv.maGiangVien || ''}</td>
                    <td>${gv.hoTenGV || ''}</td>
                    <td>${gv.loaiGiangVien || ''}</td>
                    <td>${gv.chuyenMonChinh || ''}</td>
                    <td>${gv.emailGV || ''}</td>
                    <td>${donViDisplay}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick='suaGiangVienAPI("${gv.maGiangVien}")' title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick='xacNhanXoaGiangVienAPI("${gv.maGiangVien}", "${gv.hoTenGV}")' title="Xóa"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function suaGiangVienAPI(maGiangVien) {
            try {
                const response = await fetch(`${API_URL}?action=layChiTietGiangVien&maGiangVien=${encodeURIComponent(maGiangVien)}`);
                const result = await response.json();
                if (result.success && result.data) {
                    moModalSuaGiangVien(result.data);
                } else {
                    hienThiToast('Lỗi', result.message || 'Không tìm thấy thông tin giảng viên.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "suaGiangVienAPI");
            }
        }

        function xacNhanXoaGiangVienAPI(maGiangVien, hoTenGV) {
            document.getElementById('thongTinXoaModal').textContent = `Giảng viên: ${hoTenGV} (Mã: ${maGiangVien})`;
            hamXuLyKhiXacNhanXoa = function() {
                thucHienXoaGiangVienAPI(maGiangVien, hoTenGV);
            };
            modalXacNhanXoaInstance.show();
        }

        async function thucHienXoaGiangVienAPI(maGiangVien, hoTenGV) {
            const payload = { action: 'xoaGiangVien', maGiangVien: maGiangVien };
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.success || result.thanhCong) {
                    hienThiToast('Thành công', result.message || result.thongBao || `Đã xóa giảng viên "${hoTenGV}".`, 'success');
                    taiDanhSachGiangVien();
                } else {
                    hienThiToast('Lỗi', result.message || result.thongBao || 'Xóa giảng viên thất bại.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "thucHienXoaGiangVienAPI");
            }
        }

        // --- MODULE: DANH MUC DON VI DAO TAO ---
        function moModalThemDonViDaoTao() {
            dangChinhSuaDonViDaoTao = false;
            currentDonViDaoTaoData = null;
            document.getElementById('formDonViDaoTao').reset();
            document.getElementById('maDonViDaoTaoAn').value = '';
            document.getElementById('modalDonViDaoTaoLabel').textContent = 'Thêm Đơn Vị Đào Tạo Mới';
            document.getElementById('maDonViDaoTaoModal').disabled = false;
            modalDonViDaoTaoInstance.show();
        }

        async function moModalSuaDonViDaoTao(dvdtDuLieu) {
            dangChinhSuaDonViDaoTao = true;
            currentDonViDaoTaoData = dvdtDuLieu;
            document.getElementById('formDonViDaoTao').reset();
            document.getElementById('modalDonViDaoTaoLabel').textContent = 'Chỉnh sửa Đơn Vị Đào Tạo';

            document.getElementById('maDonViDaoTaoAn').value = dvdtDuLieu.maDonViDaoTao;
            document.getElementById('maDonViDaoTaoModal').value = dvdtDuLieu.maDonViDaoTao;
            document.getElementById('maDonViDaoTaoModal').disabled = true;
            document.getElementById('tenDonViDaoTaoModal').value = dvdtDuLieu.tenDonViDaoTao;
            document.getElementById('diaChiDVDT').value = dvdtDuLieu.diaChi || "";
            document.getElementById('emailLienHeDVDT').value = dvdtDuLieu.emailLienHe || "";
            document.getElementById('soDienThoaiLienHeDVDT').value = dvdtDuLieu.soDienThoaiLienHe || "";
            document.getElementById('websiteDVDT').value = dvdtDuLieu.website || "";
            document.getElementById('nguoiDaiDienDVDT').value = dvdtDuLieu.nguoiDaiDien || "";
            document.getElementById('linhVucDaoTaoChinhDVDT').value = dvdtDuLieu.linhVucDaoTaoChinh || "";
            document.getElementById('danhGiaDonViDVDT').value = dvdtDuLieu.danhGiaDonVi || "";
            document.getElementById('ghiChuDVDT').value = dvdtDuLieu.ghiChu || "";
            
            modalDonViDaoTaoInstance.show();
        }

        async function luuDonViDaoTao() {
            const donViDaoTaoData = {
                maDonViDaoTao: document.getElementById('maDonViDaoTaoModal').value.trim(),
                tenDonViDaoTao: document.getElementById('tenDonViDaoTaoModal').value.trim(),
                diaChi: document.getElementById('diaChiDVDT').value.trim(),
                emailLienHe: document.getElementById('emailLienHeDVDT').value.trim(),
                soDienThoaiLienHe: document.getElementById('soDienThoaiLienHeDVDT').value.trim(),
                website: document.getElementById('websiteDVDT').value.trim(),
                nguoiDaiDien: document.getElementById('nguoiDaiDienDVDT').value.trim(),
                linhVucDaoTaoChinh: document.getElementById('linhVucDaoTaoChinhDVDT').value.trim(),
                danhGiaDonVi: document.getElementById('danhGiaDonViDVDT').value.trim(),
                ghiChu: document.getElementById('ghiChuDVDT').value.trim()
            };

            if (!donViDaoTaoData.tenDonViDaoTao) {
                hienThiToast('Lỗi', 'Tên đơn vị đào tạo không được để trống.', 'error'); return;
            }

            let payload;
            if (dangChinhSuaDonViDaoTao) {
                donViDaoTaoData.maDonViDaoTao = document.getElementById('maDonViDaoTaoAn').value; 
                payload = { action: 'capNhatDonViDaoTao', duLieu: donViDaoTaoData };
            } else {
                payload = { action: 'themDonViDaoTao', duLieu: donViDaoTaoData };
            }
             try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.success || result.thanhCong) {
                    hienThiToast('Thành công', result.message || result.thongBao || (dangChinhSuaDonViDaoTao ? "Cập nhật thành công!" : "Thêm mới thành công!"), 'success');
                    modalDonViDaoTaoInstance.hide();
                    taiDanhSachDonViDaoTao(); 
                } else {
                    hienThiToast('Lỗi', result.message || result.thongBao || 'Có lỗi xảy ra.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "luuDonViDaoTao");
            }
        }

        async function taiDanhSachDonViDaoTao() {
            const tbody = document.getElementById('bangDanhSachDonViDaoTao');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> Đang tải...</td></tr>';
            try {
                const response = await fetch(`${API_URL}?action=layDanhSachDonViDaoTaoDayDu`); // GOI DUNG TEN HAM
                const result = await response.json();
                if (result.success && result.data) {
                    hienThiDanhSachDonViDaoTao(result.data);
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center">${result.message || 'Không tải được dữ liệu.'}</td></tr>`;
                    hienThiToast('Lỗi', result.message || 'Không tải được danh sách đơn vị đào tạo.', 'error');
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Lỗi khi tải dữ liệu.</td></tr>';
                xuLyLoiAPI(error, "taiDanhSachDonViDaoTao");
            }
        }

        function hienThiDanhSachDonViDaoTao(danhSachDVDT) {
            const tbody = document.getElementById('bangDanhSachDonViDaoTao');
            tbody.innerHTML = '';
            if (!danhSachDVDT || danhSachDVDT.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Không có dữ liệu đơn vị đào tạo.</td></tr>';
                return;
            }
            danhSachDVDT.forEach(dv => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dv.maDonViDaoTao || ''}</td>
                    <td>${dv.tenDonViDaoTao || ''}</td>
                    <td>${dv.emailLienHe || ''}</td>
                    <td>${dv.website || ''}</td>
                    <td>${dv.linhVucDaoTaoChinh || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick='suaDonViDaoTaoAPI("${dv.maDonViDaoTao}")' title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick='xacNhanXoaDonViDaoTaoAPI("${dv.maDonViDaoTao}", "${dv.tenDonViDaoTao}")' title="Xóa"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function suaDonViDaoTaoAPI(maDonViDaoTao) {
            try {
                const response = await fetch(`${API_URL}?action=layChiTietDonViDaoTao&maDonViDaoTao=${encodeURIComponent(maDonViDaoTao)}`);
                const result = await response.json();
                if (result.success && result.data) {
                    moModalSuaDonViDaoTao(result.data);
                } else {
                    hienThiToast('Lỗi', result.message || 'Không tìm thấy thông tin đơn vị đào tạo.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "suaDonViDaoTaoAPI");
            }
        }

        function xacNhanXoaDonViDaoTaoAPI(maDonViDaoTao, tenDonViDaoTao) {
            document.getElementById('thongTinXoaModal').textContent = `Đơn vị đào tạo: ${tenDonViDaoTao} (Mã: ${maDonViDaoTao})`;
            hamXuLyKhiXacNhanXoa = function() {
                thucHienXoaDonViDaoTaoAPI(maDonViDaoTao, tenDonViDaoTao);
            };
            modalXacNhanXoaInstance.show();
        }

        async function thucHienXoaDonViDaoTaoAPI(maDonViDaoTao, tenDonViDaoTao) {
             const payload = { action: 'xoaDonViDaoTao', maDonViDaoTao: maDonViDaoTao };
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.success || result.thanhCong) {
                    hienThiToast('Thành công', result.message || result.thongBao || `Đã xóa đơn vị đào tạo "${tenDonViDaoTao}".`, 'success');
                    taiDanhSachDonViDaoTao();
                } else {
                    hienThiToast('Lỗi', result.message || result.thongBao || 'Xóa đơn vị đào tạo thất bại.', 'error');
                }
            } catch (error) {
                xuLyLoiAPI(error, "thucHienXoaDonViDaoTaoAPI");
            }
        }


        // --- MODULE: CHON NHAN VIEN DAO TAO (Se can cap nhat de dung API) ---
        // Cac ham nhu taiKhoaHocVaoSelectChonNhanVien, taiPhongBanVaoFilterChonNhanVien, 
        // taiDanhSachNhanVienCoTheChon, luuDanhSachHocVienDaChon se can goi API
        // Vi du:
        async function taiKhoaHocVaoSelectChonNhanVien() {
            const selectKhoaHoc = document.getElementById('selectKhoaHocChoNhanVien');
            selectKhoaHoc.innerHTML = '<option value="">Đang tải khóa học...</option>';
            try {
                const response = await fetch(`${API_URL}?action=layDanhSachKhoaHoc`);
                const result = await response.json();
                selectKhoaHoc.innerHTML = '<option value="">Vui lòng chọn khóa học...</option>';
                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(kh => {
                        selectKhoaHoc.innerHTML += `<option value="${kh.maKhoaHoc}">${kh.tenKhoaHoc} (Mã: ${kh.maKhoaHoc})</option>`;
                    });
                } else {
                     selectKhoaHoc.innerHTML = '<option value="">Không có khóa học nào.</option>';
                }
            } catch (error) {
                xuLyLoiAPI(error, "taiKhoaHocVaoSelectChonNhanVien");
                selectKhoaHoc.innerHTML = '<option value="">Lỗi tải khóa học</option>';
            }
        }
        // ... cac ham khac cua module nay can duoc cap nhat tuong tu ...
        function taiDanhSachNhanVienCoTheChon() { hienThiToast("Thông báo", "Chức năng đang được cập nhật để dùng API.", "info");}
        function hienThiDanhSachNhanVienDeChon(danhSachNhanVien) {}
        function xuLyChonTatCaNhanVien(trangThaiChecked) {}
        function xuLyChonMotNhanVien(checkboxElement) {}
        function capNhatDanhSachNhanVienDaChonUI() {}
        function boChonNhanVienTuDanhSach(maNhanVien) {}
        function luuDanhSachHocVienDaChon() { hienThiToast("Thông báo", "Chức năng đang được cập nhật để dùng API.", "info");}
        function xuatDanhSachHocVien() {}
        function taiPhongBanVaoFilterChonNhanVien() {
             const selectPhongBan = document.getElementById('filterPhongBan');
            selectPhongBan.innerHTML = '<option value="">Đang tải phòng ban...</option>';
            fetch(`${API_URL}?action=layDanhSachPhongBan`)
                .then(response => response.json())
                .then(result => {
                    selectPhongBan.innerHTML = '<option value="">Tất cả phòng ban</option>';
                    if (result.success && result.data) {
                        result.data.forEach(pb => {
                            selectPhongBan.innerHTML += `<option value="${pb.maPhongBan}">${pb.tenPhongBan}</option>`;
                        });
                    }
                })
                .catch(error => xuLyLoiAPI(error, "taiPhongBanVaoFilterChonNhanVien"));
        }


    </script>
</body>
</html>
